# 04.wrk_IS

インサイドセールス（IS）管理システム

## 概要

Google Apps Scriptで実装されたインサイドセールス管理システムです。複数のリードソースから顧客データを取り込み、架電リストの生成、架電結果の記録、KPI集計を行うことができます。

## 主要機能

### 1. データ取込・統合（ETL処理）

**ファイル**: `03_EtlService.js`

- 複数の元リスト（プレゼント受け取りリスト、セミナーアンケート、キャンセルリストなど）から顧客データを取り込み
- 顧客マスタ（M_CUSTOMER）とリードソースマスタ（M_LEAD_SOURCE）に統合
- 重複判定（電話番号・LINE名で判定）と自動更新
- 新規ソースの追加に対応（Config.jsの設定で対応可能）

**実行方法**: カスタムメニュー「IS管理システム」→「データ取込・統合（ETL）実行」

### 2. 今日の架電リスト生成

**ファイル**: `04_CallListService.js`

- 担当ISごとに「今日架電すべきリスト」を自動生成
- 生成条件：
  - ステータスが「未接触」または「架電中」
  - 今日既に架電していない
  - 次回アクション日が今日以前
- 各IS用に`TODAY_CALL_{担当IS名}`シートを作成

**実行方法**: カスタムメニュー「IS管理システム」→「今日の架電リスト生成」

### 3. 架電結果の登録

**ファイル**: `05_CallLogService.js`

- TODAY_CALL_*シートの編集を自動検知（onEditトリガー）
- 架電結果をT_CALL_LOGに自動登録
- アポイント情報をT_APPOINTMENTに自動登録
- 顧客のステータス（status_overall）を自動更新

**実行方法**: TODAY_CALL_*シートでステータスを入力すると自動実行

### 4. KPI集計

**ファイル**: `06_KpiService.js`

#### 4.1 日次KPI集計

- 日別×担当者別×ソース別でKPIを集計
- 集計項目：
  - 架電回数、通電回数、通電率
  - アポ取得数、アポ取得率
  - 着席数、着席率
  - 成約数、成約率
- 結果をV_KPI_DAILYシートに出力

**実行方法**: カスタムメニュー「IS管理システム」→「KPI集計（日次）」

#### 4.2 リスト別KPI集計

- ソース種別×ソース詳細別でKPIを集計
- 直近1ヶ月のデータを集計
- 結果をV_KPI_BY_LISTシートに出力

**実行方法**: カスタムメニュー「IS管理システム」→「KPI集計（リスト別）」

### 5. 架電管理シート管理

**ファイル**: `07_CallManagementService.js`

- インサイドセールス用架電管理シート（IS_架電管理）の作成・管理
- キャンセルリスト（別スプレッドシート）からデータを同期
- システム側でセットする列と担当者が入力する列を分離
- データ検証（プルダウン）の自動設定

**実行方法**: 
- カスタムメニュー「IS管理システム」→「【架電管理】シート設定」
- カスタムメニュー「IS管理システム」→「【架電管理】キャンセルリスト同期」

## 補助機能

### ログ出力

**ファイル**: `01_Logger.js`

- すべての処理ログをLOGSシートに記録
- ログレベル：INFO、WARN、ERROR
- 関数名、メッセージ、スタックトレースを記録

### 共通ユーティリティ

**ファイル**: `02_Utils.js`

- シート操作（取得・作成・バッチ処理）
- データ変換（配列↔オブジェクト）
- ID生成、日時フォーマット
- 電話番号の正規化
- データ検索・フィルタリング

### 設定管理

**ファイル**: `00_Config.js`

- システム全体の設定を一元管理
- シート名、列定義、ステータス定義
- ソース設定（元データの場所とマッピングルール）
- 新規ソース追加時はこのファイルを編集

## データ構造

### マスタテーブル

- **M_CUSTOMER**: 顧客マスタ
  - customer_id, line_name, full_name, phone_number, email, status_overall, created_at, updated_at

- **M_LEAD_SOURCE**: リードソースマスタ
  - lead_source_id, customer_id, source_type, source_detail, list_added_date, event_date, created_at, updated_at

### トランザクションテーブル

- **T_CALL_LOG**: 架電活動ログ
  - call_id, customer_id, lead_source_id, assigned_is, call_datetime, call_count, status, note_rank, next_action_date, memo, created_at, updated_at

- **T_APPOINTMENT**: アポイント情報
  - appointment_id, customer_id, from_call_id, appointment_created_datetime, meeting_datetime, attendance_status, deal_status, deal_amount, created_at, updated_at

### ビューテーブル

- **V_KPI_DAILY**: KPI日次集計
- **V_KPI_BY_LIST**: KPIリスト別集計

### 作業用シート

- **TODAY_CALL_{担当IS名}**: 今日の架電リスト（各IS用）
- **IS_架電管理**: インサイドセールス用架電管理シート
- **LOGS**: ログ記録シート

## ステータス定義

### 顧客ステータス（status_overall）

- `未接触`: まだ架電していない
- `架電中`: 架電活動中
- `アポ中`: アポイント取得済み
- `クローズ`: 成約または失注

### 架電ステータス（T_CALL_LOG.status）

- `最架電`: 再度架電が必要（通電カウント対象）
- `通電`: 電話がつながった（通電カウント対象）
- `アポ調整`: アポイント調整中（通電カウント対象）
- `留守電`: 留守電にメッセージを残した（通電カウント対象）
- `NG`: 興味なし・断られた（通電カウント対象）
- `不在`: 不在（通電カウント対象外）
- `話中`: 話中（通電カウント対象外）
- `不通`: 電話がつながらない（通電カウント対象外）

## カスタムメニュー

スプレッドシートを開くと「IS管理システム」メニューが表示されます。

### メイン機能

- **データ取込・統合（ETL）実行**: 元リストからデータを取り込み、マスタに統合
- **今日の架電リスト生成**: 担当ISごとに架電リストを生成
- **KPI集計（日次）**: 日次KPIを集計
- **KPI集計（リスト別）**: リスト別KPIを集計
- **全処理実行**: ETL → リスト生成 → KPI集計を順次実行

### 架電管理

- **【架電管理】シート設定**: 架電管理シートの作成・初期化
- **【架電管理】キャンセルリスト同期**: キャンセルリストを架電管理シートに同期

### デバッグ機能

- **【デバッグ】ソース設定テスト**: ソース設定と元データシートの存在確認
- **【デバッグ】架電対象確認**: 顧客マスタと架電対象の確認

## ファイル構成

```
04.wrk_IS/
├── 00_Config.js              # 設定管理
├── 01_Logger.js              # ログ出力
├── 02_Utils.js               # 共通ユーティリティ
├── 03_EtlService.js          # ETL処理
├── 04_CallListService.js     # 架電リスト生成
├── 05_CallLogService.js      # 架電結果登録
├── 06_KpiService.js          # KPI集計
├── 07_CallManagementService.js  # 架電管理シート管理
├── 99_Main.js                # カスタムメニュー定義
└── README.md                 # このファイル
```

## 使用方法

### 初回セットアップ

1. `00_Config.js`の`ASSIGNED_IS_LIST`に担当IS名を設定
2. `00_Config.js`の`SOURCE_CONFIGS`に元データのシート名と列マッピングを設定
3. カスタムメニュー「IS管理システム」→「データ取込・統合（ETL）実行」を実行

### 日常運用

1. **データ取込**: カスタムメニュー「IS管理システム」→「データ取込・統合（ETL）実行」
2. **リスト生成**: カスタムメニュー「IS管理システム」→「今日の架電リスト生成」
3. **架電実施**: 各ISが`TODAY_CALL_{担当IS名}`シートで架電結果を入力
4. **KPI集計**: カスタムメニュー「IS管理システム」→「KPI集計（日次）」または「KPI集計（リスト別）」

## 注意事項

- 大量データ処理時はAPI制限に注意（処理中に自動的に待機時間を挿入）
- ログはLOGSシートに記録されるため、定期的に確認を推奨
- 新規ソースを追加する場合は`00_Config.js`の`SOURCE_CONFIGS`に設定を追加
- キャンセルリスト同期機能を使用する場合は、`00_Config.js`の`CANCEL_LIST_SPREADSHEET_ID`と`CANCEL_LIST_SHEET_NAME`を設定